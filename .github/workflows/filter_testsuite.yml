name: Filter Testsuite

on:
  issue_comment:
      types: [created]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v3
        id: check
        with:
         result-encoding: string
         script: |
           const userName = context.payload.comment.user.login
           if(userName == 'maxGimeno') {
             const body = context.payload.comment.body
             if(body.includes("/testme")) {             
               return 'OK'
             }
           }
           return 'stop'
      - uses: actions/github-script@v3
        if: steps.check.result != 'stop'
        id: get_label
        with:
         result-encoding: string
         script: |
           //get branch name and username
           const pr_url = context.payload.issue.pull_request.url
           const pr_content = await github.request(pr_url)
           const label = pr_content.data.head.label
           console.log(label)
           return label
      - uses: actions/github-script@v3
        if: steps.check.result != 'stop'
        id: get_base
        with:
         result-encoding: string
         script: |
           //get branch name and username   
           const pr_url = context.payload.issue.pull_request.url
           const pr_content = await github.request(pr_url)
           const base = pr_content.data.base.ref
           console.log(base)
           return base
      - name: Run Testsuite
        if: steps.check.outputs.result != 'stop'
        run: |
          mkdir -p ~/.ssh
          #ssh key
          (
          cat <<EOF
          ${{ secrets.ssh_key }}
          EOF
          )>> ~/.ssh/id_rsa
          chmod 600 /home/runner/.ssh/id_rsa 
          #ssh public key
          (
          cat <<EOF
          ${{ secrets.ssh_key_pub }}
          EOF
          )>> ~/.ssh/id_rsa.pub
          #known hosts
          chmod 644 /home/runner/.ssh/id_rsa.pub
          (
          cat <<EOF
          geometryfactory.pro.dns-orange.fr ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBF9KCvu41PSuTf1sd2zLFb0E4jw40hlWPzW+l62sbDn2FugyR5kR87sA58TdHgdlyshSjf+In3tdi45fPIepy+U=
          192.168.2.106 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCZEBqjdmSNpe0H+RbNney/InmuW9HuvzA6lYePmOBGqW1UjepYbBiIhPNZkS7luuw6zZJU9tYYedsNgntkOmEM=
          EOF
          )>> ~/.ssh/known_hosts
          #config file
          (
          cat <<EOF
          Host sosno-via-renoir
          ProxyCommand ssh -q mgimeno@geometryfactory.pro.dns-orange.fr nc 192.168.2.106 %p
          User cgaltest
          Hostname 192.168.2.106
          EOF
          )>> ~/.ssh/config
          #ssh command
          LABEL="${{ steps.get_label.outputs.result }}"
          USER_NAME=$(echo $LABEL | cut -d':' -f 1)
          BRANCH_NAME=$(echo $LABEL | cut -d':' -f 2)
          BASE="${{ steps.get_base.outputs.result }}"
          #ssh sosno-via-renoir "cd C:/filter_test && echo '$USER_NAME $BRANCH_NAME $BASE' > coucou.txt"
          ssh sosno-via-renoir "cd C:/filter_test && bash ./run_testsuite_from_branch_name.sh $USER_NAME $BRANCH_NAME $BASE"
          echo "ssh sent"
      - name: Post address
        uses: actions/github-script@v3
        if: steps.check.outputs.result != 'stop'
        with:
          script: |
            const address = "The testsuite is lauched. results will be found, after it is done, here : https://cgal.geometryfactory.com/~mgimeno/test_suite/TESTRESULTS/index.shtml "
            github.issues.createComment({
              owner: "maxGimeno",
              repo: "cgal",
              issue_number: ${{ github.event.issue.number }},
              body: address
            });
